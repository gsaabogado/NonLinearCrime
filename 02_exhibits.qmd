---
title: "Study Exhibits"
author: "Luis Sarmiento"
format: 
  html: 
    toc: true
    warning: false
    code-fold: true
    code-summary: "Show the Code"
---

# Results section

@tbl-Table2 contains the coefficients on the linear effect of the Now Cast AQI on crime counts in New York and Mexico City

```{r}
#| label: tbl-Table2
#| tbl-cap: Effect of pollution on criminality (linear model)
#| tbl-cap-location: top
#| echo: true
# Set the path 
file = paste0(gsub("NonLinearCrime/","", getwd()), "/ReplicationFolder/")
# Load the data
tab = read_rds(paste0(file, "/02_GenData/04_results/PoissonLinear.rds"))
# Take the exponent of point estimates
tab = tab %>% mutate_at(vars(est, se), function(x) x = (exp(x) -1)*100*10)
# Paste the city and the specification 
tab = mutate(tab, specification = paste(city, specification, sep = "-"))
# Split the data set by the distinct specifications 
tab = split(tab, f = tab$specification)
# Create the data-frame for the html table
tab = matrixreg(lapply(lapply(tab, function(y) 
  y = dplyr::filter(y, var == "NowCast")),function(x) 
    createTexreg("", x$est,x$se, x$p,
                 gof.names = c(rep("R.Squared", nrow(x)), rep("N.Obs", nrow(x)) , rep("BIC", nrow(x))),
                 gof = c(x$r, x$N, x$BIC),gof.decimal = c(rep(T, nrow(x)), rep(F, nrow(x)), rep(F, nrow(x))))),
  booktabs = T, symbol = "+", digits = 3,stars = c(0.01, 0.05, 0.1)) %>% as.data.frame(.)
# Style the data frame 
rownames(tab) = c("names", "Estimate", "", "N.obs", "R2", "BIC") 
tab = select(tab, -V1); colnames(tab) = tab[1,]; tab = tab[-1, ]
# change the column names 
colnames(tab) = paste0("(", rep(seq(1,3,1),2), ")")
# Create the HTML table of the first figure
kbl(tab, align = "c")  %>%
  kable_classic() %>%
  kable_styling(font_size = 12, full_width = F) %>%
  add_header_above(c(" " = 1, "MexicoCity" = 3, "New York" = 3)) %>%
  kable_styling(bootstrap_option = c("hover")) %>%
  pack_rows("Fitted-Statistics", 3, 5) %>%
  footnote(general = "$^{***}p<0.01$, $^{**}p<0.05$, $^*p<0.1$. This table shows the effect of the Now Cast AQI on the number of crimes occurring in a two-kilometer radius around pollution measuring stations in Mexico City and New York. I present estimates for three different specifications; (1) controls for station, month, hour, and weekday fixed effects, (2) accounts for seasonality by including an interaction term of year-by-month fixed effects, and (3) further interacts year-by-month with station fixed effects. Interpret point estimates as the percentage change in the number of crimes due to a ten units increase in the Now Cast AQI. Results come from a PMLE panel model -- standard errors clustered at the station level.", general_title = "Notes:", footnote_as_chunk = T)
```


@tbl-Table3 contains the coefficients of the quadratic model estimating the relationship between pollution and criminality in Mexico city and New York

```{r}
#| label: tbl-Table3
#| tbl-cap: Effect of pollution on criminality (quadratic model)
#| tbl-cap-location: top
#| echo: true
# Set the path 
file = paste0(gsub("NonLinearCrime/","", getwd()), "/ReplicationFolder/")
# Load the data
tab = read_rds(paste0(file, "02_GenData/04_results/PoissonQuadratic.rds"))
# Take the exponent of point estimates
tab = tab %>% mutate_at(vars(est, se), function(x) x = (exp(x) -1)*100*10)
# Paste the city and the specification 
tab = mutate(tab, specification = paste(city, specification, sep = "-"))
# Split the data set by the distinct specifications 
tab = split(tab, f = tab$specification)
# Create the data-frame for the html table
tab = matrixreg(lapply(lapply(tab, function(y) 
  y = dplyr::filter(y, var == "NowCast")),function(x) 
    createTexreg(x$estimate, x$est,x$se, x$p,
                 gof.names = c(rep("R.Squared", nrow(x)), rep("N.Obs", nrow(x)) , rep("BIC", nrow(x))),
                 gof = c(x$r, x$N, x$BIC),gof.decimal = c(rep(T, nrow(x)), rep(F, nrow(x)), rep(F, nrow(x))))),
  booktabs = T, symbol = "+", digits = 3,stars = c(0.01, 0.05, 0.1)) %>% as.data.frame(.)
# Style the data frame 
rownames(tab) = c("names", "Linear", " ", "Quadratic", "", "N.obs", "R2", "BIC") 
tab = select(tab, -V1); colnames(tab) = tab[1,]; tab = tab[-1, ]
# change the column names 
colnames(tab) = paste0("(", rep(seq(1,3,1),2), ")")
# Create the HTML table of the first figure
kbl(tab, align = "c")  %>%
  kable_classic() %>%
  kable_styling(font_size = 12, full_width = F) %>%
  add_header_above(c(" " = 1, "MexicoCity" = 3, "New York" = 3)) %>%
  kable_styling(bootstrap_option = c("hover")) %>%
  pack_rows("Fitted-Statistics", 5, 7) %>%
  footnote(general = "$^{***}p<0.01$, $^{**}p<0.05$, $^*p<0.1$. This table shows the effect of the linear and squared value of the Now Cast AQI on fthe number of crimes occurring in a two-kilometer radius around pollution measuring stations in Mexico City and New York. Interpret point estimates as the percentage change in the number of crimes due to a ten units increase in the Now Cast AQI. Results come from a PMLE panel model across three different specifications. Column (1) controls for station, month, hour, and weekday fixed effects, (2) includes an interaction term of year-by-month fixed effects, and (3) adds the interaction of year-by-month-by-station fixed effects. All three specifications further control linearly for wind speed and relative humidity and nonparametrically for temperature, rain, and the interaction of relative humidity and temperature -- standard errors clustered at the station level.", footnote_as_chunk = T)
```

@tbl-Table4 contains the coefficients of the linear and quadratic models on the relationship between pollution and criminality for violent and nonviolent crimes in Mexico city and New York

```{r}
#| label: tbl-Table4
#| tbl-cap: Estimates on the effects of air pollution for violent and non-violent crimes
#| tbl-cap-location: top
#| echo: true
# Set the path 
file = paste0(gsub("NonLinearCrime/","", getwd()), "/ReplicationFolder/")
# Load the data
tab = read_rds(paste0(file, "02_GenData/04_results/PoissonQuadraticViolent.rds"))
# Take the exponent of point estimates
tab = tab %>% mutate_at(vars(est, se), function(x) x = (exp(x) -1)*100*10)
#### Change the names of the types of crime ####
tab = mutate(tab, dependent = mgsub(dependent, c("NonViolent"), c("Non Violent")))
# Paste the city and the specification 
tab = mutate(tab, specification = paste(city, specification, estimate, sep = "-"))
# Split the data set by the distinct specifications 
tab = split(tab, f = tab$specification)
# Create the data-frame for the html table
violent = matrixreg(lapply(lapply(tab, function(y) 
  y = dplyr::filter(y, var == "NowCast", dependent == "Violent")),function(x) 
    createTexreg(x$dependent, x$est,x$se, x$p,
                 gof.names = c(rep("R.Squared", nrow(x)), rep("N.Obs", nrow(x)) , rep("BIC", nrow(x))),
                 gof = c(x$r2, x$n, x$BIC),gof.decimal = c(rep(T, nrow(x)), rep(F, nrow(x)), rep(F, nrow(x))))),
  booktabs = T, symbol = "+", digits = 3,stars = c(0.01, 0.05, 0.1)) %>% as.data.frame(.)
# Style the data frame 
rownames(violent) = c("names", "", " ", "N.obs", "R2", "BIC") 
violent = select(violent, -V1); colnames(violent) = violent[1,]; violent = violent[-1, ]
# Create the data-frame for the html table
nonviolent = matrixreg(lapply(lapply(tab, function(y) 
  y = dplyr::filter(y, var == "NowCast", dependent == "Non Violent")),function(x) 
    createTexreg(x$dependent, x$est,x$se, x$p,
                 gof.names = c(rep("R.Squared", nrow(x)), rep("N.Obs", nrow(x)) , rep("BIC", nrow(x))),
                 gof = c(x$r2, x$n, x$BIC),gof.decimal = c(rep(T, nrow(x)), rep(F, nrow(x)), rep(F, nrow(x))))),
  booktabs = T, symbol = "+", digits = 3,stars = c(0.01, 0.05, 0.1)) %>% as.data.frame(.)
# Style the data frame 
rownames(nonviolent) = c("names", "  ", "   ", "N.obs ", "R2 ", "BIC ") 
nonviolent = select(nonviolent, -V1); colnames(nonviolent) = nonviolent[1,]; nonviolent = nonviolent[-1, ]
#
html = rbind(violent ,nonviolent)
# change the column names 
colnames(html) = paste0("(", rep(c("Linear", "Linear", "Quadratic"),2), ")")
# Create the HTML table of the first figure
kbl(html, align = "c")  %>%
  kable_classic() %>%
  kable_styling(font_size = 12, full_width = F) %>%
  add_header_above(c(" " = 1, "Linear Model" = 1, "Quadratic Model" = 2, "Linear Model" = 1, "Quadratic Model" = 2)) %>%
  add_header_above(c(" " = 1, "MexicoCity" = 3, "New York" = 3)) %>%
  kable_styling(bootstrap_option = c("hover")) %>%
   pack_rows("Violent", 1, 5) %>%
  pack_rows("Non Violent", 6, 10) %>%
  footnote(general = "$^{***}p<0.01$, $^{**}p<0.05$, $^*p<0.1$. This table shows the effect of the linear and squared value of the Now Cast AQI on fthe number of crimes occurring in a two-kilometer radius around pollution measuring stations in Mexico City and New York. Interpret point estimates as the percentage change in the number of crimes due to a ten units increase in the Now Cast AQI. Results come from a PMLE panel model across three different specifications. Column (1) controls for station, month, hour, and weekday fixed effects, (2) includes an interaction term of year-by-month fixed effects, and (3) adds the interaction of year-by-month-by-station fixed effects. All three specifications further control linearly for wind speed and relative humidity and nonparametrically for temperature, rain, and the interaction of relative humidity and temperature -- standard errors clustered at the station level.", footnote_as_chunk = T) %>%  scroll_box(height = "500px") 
```

@tbl-Table5 contains the estimates on the effects across all crime categories.

```{r}
#| label: tbl-Table5
#| tbl-cap: Estimates on the effects of air pollution across different crime categories
#| tbl-cap-location: top
#| echo: true
# Set the path 
file = paste0(gsub("NonLinearCrime/","", getwd()), "/ReplicationFolder/")
# Load the data
tab = read_rds(paste0(file, "02_GenData/04_results/PoissonQuadraticOtherCrimes.rds"))
# Take the exponent of point estimates
tab = tab %>% mutate_at(vars(est, se), function(x) x = (exp(x) -1)*100*10)
# Paste the city and the specification 
tab = mutate(tab, specification = paste(city, specification, estimate, sep = "-"))
# Split the data set by the distinct specifications 
tab = split(tab, f = tab$specification)
# Create the data-frame for the html table
tab = matrixreg(lapply(lapply(tab, function(y) 
  y = dplyr::filter(y, var == "NowCast")),function(x) 
    createTexreg(x$dependent, x$est,x$se, x$p,
                 gof.names = c(rep("R.Squared", nrow(x)), rep("N.Obs", nrow(x)) , rep("BIC", nrow(x))),
                 gof = c(x$r2, x$n, x$BIC),gof.decimal = c(rep(T, nrow(x)), rep(F, nrow(x)), rep(F, nrow(x))))),
  booktabs = T, symbol = "+", digits = 3,stars = c(0.01, 0.05, 0.1)) %>% as.data.frame(.)
# change the column names 
colnames(tab) = c("", rep(c("Linear", "Linear", "Quadratic"),2))
tab = tab[-1,]
tab = tab[-c(16,17,18),]
# Create the HTML table of the first figure
kbl(tab, align = "c") %>%
  kable_classic() %>%
  kable_styling(font_size = 12) %>%
  add_header_above(c(" " = 2, "Linear Model" = 1, "Quadratic Model" = 2, "Linear Model" = 1, "Quadratic Model" = 2)) %>%
  add_header_above(c(" " = 2, "MexicoCity" = 3, "New York" = 3)) %>%
  kable_styling(bootstrap_option = c("hover")) %>%
  footnote(general = "$^{***}p<0.01$, $^{**}p<0.05$, $^*p<0.1$. This table shows the effect of the linear and squared value of the Now Cast AQI on fthe number of crimes occurring in a two-kilometer radius around pollution measuring stations in Mexico City and New York. Interpret point estimates as the percentage change in the number of crimes due to a ten units increase in the Now Cast AQI. Results come from a PMLE panel model across three different specifications. Column (1) controls for station, month, hour, and weekday fixed effects, (2) includes an interaction term of year-by-month fixed effects, and (3) adds the interaction of year-by-month-by-station fixed effects. All three specifications further control linearly for wind speed and relative humidity and nonparametrically for temperature, rain, and the interaction of relative humidity and temperature -- standard errors clustered at the station level.", footnote_as_chunk = T) %>%  scroll_box(height = "500px") 
```

@tbl-Table6 contains the main results of the IV strategy

```{r}
#| label: tbl-Table6
#| tbl-cap: Effects of air pollution on criminality (IV)
#| tbl-cap-location: top
#| echo: true
# Set the path 
file = paste0(gsub("NonLinearCrime/","", getwd()), "/ReplicationFolder/")
# Load the data
tab = list(read_rds(paste0(file, "/02_GenData/04_results/99_iv/LinearWdr8.rds")),
          read_rds(paste0(file, "/02_GenData/04_results/99_iv/QuadWdr8.rds")))
#### Bind the estimates together ####
tab = rbindlist(tab, idcol = "model") %>%
  mutate(var = ifelse(grepl("2", var), "Quadratic", "Linear"))
#### Take the exponent of the point estimates ####
tab = tab %>% mutate_at(vars(est, se), function(x) x = (exp(x) -1)*100*10)
#### Split the data set by the distinct specifications ####
tab = mutate(tab, city = paste(model, city, var))
tab = split(tab, f = tab$city)
# Create the data-frame for the html table
tab = matrixreg(lapply(lapply(tab, function(y) 
  y = y),function(x) 
    createTexreg("", x$est,x$se, x$p,
                 gof.names = c(rep("R.Squared", nrow(x)), rep("N.Obs", nrow(x)) , rep("BIC", nrow(x))),
                 gof = c(x$r2, x$n, x$BIC),gof.decimal = c(rep(T, nrow(x)), rep(F, nrow(x)), rep(F, nrow(x))))),
  booktabs = T, symbol = "+", digits = 3,stars = c(0.01, 0.05, 0.1)) %>% as.data.frame(.)
# change the column names 
colnames(tab) = c("","Linear", "Linear ", "Linear  ", "Quadratic", " Linear", "Quadratic ")
rownames(tab) = c("   ","", " ", "R.Squared", "N.Obs", "BIC"); tab = tab[-1,-1]
# Create the HTML table of the first figure
kbl(tab, align = "c") %>%
  kable_classic() %>%
  kable_styling(font_size = 12) %>%
  add_header_above(c(" " = 1, "Mexico City" = 1, "New York" = 1, "Mexico City" = 2, "New York" = 2)) %>%
  add_header_above(c(" " = 1, "Linear Model" = 2, "Quadratic Model" = 4)) %>%
  kable_styling(bootstrap_option = c("hover")) %>%   pack_rows("Fitted-Statistics", 3, 5) %>%
  footnote(general = "$^{***}p<0.01$, $^{**}p<0.05$, $^*p<0.1$. This table shows the effect of the linear and squared value of the Now Cast AQI on fthe number of crimes occurring in a two-kilometer radius around pollution measuring stations in Mexico City and New York. Interpret point estimates as the percentage change in the number of crimes due to a ten units increase in the Now Cast AQI. Results come from a PMLE panel model across three different specifications. Column (1) controls for station, month, hour, and weekday fixed effects, (2) includes an interaction term of year-by-month fixed effects, and (3) adds the interaction of year-by-month-by-station fixed effects. All three specifications further control linearly for wind speed and relative humidity and nonparametrically for temperature, rain, and the interaction of relative humidity and temperature -- standard errors clustered at the station level.", footnote_as_chunk = T) %>%  scroll_box(height = "500px") 
```





